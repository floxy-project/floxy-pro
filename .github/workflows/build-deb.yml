name: Build DEB Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-deb:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from git tag (e.g., v1.0.0 -> 1.0.0)
            VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build floxyctl binary
        run: |
          GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="-w -s" -o floxyctl ./cmd/floxyctl

      - name: Create DEB package structure
        run: |
          PACKAGE_NAME="floxyctl"
          PACKAGE_VERSION="${{ steps.version.outputs.version }}"
          ARCH="amd64"
          
          # Get current date in RFC822 format for changelog
          CHANGELOG_DATE=$(date -R)
          
          # Create package directory structure
          mkdir -p deb-package/DEBIAN
          mkdir -p deb-package/usr/bin
          mkdir -p deb-package/usr/share/doc/${PACKAGE_NAME}
          
          # Copy binary
          cp floxyctl deb-package/usr/bin/
          chmod +x deb-package/usr/bin/floxyctl
          
          # Create control file
          cat > deb-package/DEBIAN/control << EOF
          Package: ${PACKAGE_NAME}
          Version: ${PACKAGE_VERSION}
          Architecture: ${ARCH}
          Maintainer: Roman Chudov <roman@chudov.gmail.com>
          Description: Floxy workflow engine CLI tool
           Floxy is a Go library for creating and executing workflows with a custom DSL.
           Implements the Saga pattern with orchestrator approach.
          Priority: optional
          EOF
          
          # Create changelog file
          cat > deb-package/usr/share/doc/${PACKAGE_NAME}/changelog.Debian << EOF
          ${PACKAGE_NAME} (${PACKAGE_VERSION}) unstable; urgency=medium

            * Initial release of floxyctl
            * Version ${PACKAGE_VERSION}

           -- Roman Chudov <roman@chudov.gmail.com>  ${CHANGELOG_DATE}
          EOF
          gzip -9 deb-package/usr/share/doc/${PACKAGE_NAME}/changelog.Debian
          
          # Create copyright file
          COPYRIGHT_YEAR=$(date +%Y)
          cat > deb-package/usr/share/doc/${PACKAGE_NAME}/copyright << EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: floxyctl
          Source: https://github.com/rom8726/floxy

          Files: *
          Copyright: Copyright (c) ${COPYRIGHT_YEAR} Roman Chudov
          License: See LICENSE file in source repository
          EOF
          
          # Create postinst script (optional)
          cat > deb-package/DEBIAN/postinst << 'EOFSCRIPT'
          #!/bin/bash
          set -e
          # Add any post-installation steps here
          exit 0
          EOFSCRIPT
          chmod +x deb-package/DEBIAN/postinst
          
          # Create prerm script (optional)
          cat > deb-package/DEBIAN/prerm << 'EOFSCRIPT'
          #!/bin/bash
          set -e
          # Add any pre-removal steps here
          exit 0
          EOFSCRIPT
          chmod +x deb-package/DEBIAN/prerm

      - name: Build DEB package
        run: |
          PACKAGE_NAME="floxyctl"
          PACKAGE_VERSION="${{ steps.version.outputs.version }}"
          ARCH="amd64"
          
          # Build package manually with gzip compression to ensure compatibility
          # This avoids zst compression that older Aptly versions don't support
          cd deb-package
          
          # Create debian-binary file
          echo "2.0" > debian-binary
          
          # Create control.tar.gz
          cd DEBIAN
          tar czf ../control.tar.gz *
          cd ..
          
          # Create data.tar.gz (everything except DEBIAN and temporary files)
          # Use tar with exclusions to preserve directory structure
          tar czf data.tar.gz \
            --exclude='./DEBIAN' \
            --exclude='./debian-binary' \
            --exclude='./control.tar.gz' \
            --exclude='./data.tar.gz' \
            --numeric-owner \
            --owner=0 \
            --group=0 \
            usr/
          
          # Create deb package using ar
          ar r ${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb debian-binary control.tar.gz data.tar.gz
          
          # Cleanup temporary files
          rm -f debian-binary control.tar.gz data.tar.gz
          
          # Move package to parent directory
          mv ${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb ..
          cd ..
          
          echo "DEB package created: ${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb"
          ls -lh *.deb
          
          # Verify compression type (should show gzip)
          echo "Verifying compression type..."
          ar t ${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb
          file control.tar.gz data.tar.gz 2>/dev/null || echo "Package structure verified"

      - name: Upload DEB package artifact
        uses: actions/upload-artifact@v4
        with:
          name: floxyctl-deb-amd64
          path: floxyctl_*.deb
          retention-days: 90

      - name: Create or Update GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        continue-on-error: true
        uses: softprops/action-gh-release@v1
        with:
          files: floxyctl_*.deb
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
